<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Celebrity</title>

    <script defer src="/__/firebase/7.14.3/firebase-app.js"></script>
    <script defer src="/__/firebase/7.14.3/firebase-database.js"></script>
    <script defer src="/__/firebase/init.js"></script>

    <style media="screen">
      #container {margin: 16px;}
    </style>
  </head>
  <body>
    <div id="container">
      <input type="text" placeholder="Enter a word, press enter" id="input"/>
      <div>
        <span id="num">[Loading]</span> in the hat.
      </div>
      <button id="pop">Take one out</button>
      <div id="revealed"></div>
      <div>
        <button id="reset">Put all back</button>
      </div>
      <div>
        <button id="trash">Throw everything out</button>
      </div>
    </body>
    <p id="load"></p>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // The Firebase SDK is initialized and available here
        try {          
          let database = firebase.database();

          // Input
          let input = document.getElementById('input');
          input.addEventListener('keyup', e => {
              if (e.keyCode === 13) {
                  database.ref('phrases/' + Date.now()).set({
                    "phrase": input.value,
                    "inHat": true,
                  });
                  input.value = "";
              }
          });

          // Num left
          database.ref('phrases').on('value', snapshot => {
            let num = 0;
            snapshot.forEach(child => {
              if (child.val()["inHat"] === true) {
                num += 1;
              }
            });
            document.getElementById("num").textContent = num;
          });

          // Take one out
          let pop = document.getElementById('pop');
          pop.addEventListener('click', e => {
            database.ref('phrases').once('value').then( snapshot => {
              // filter to inHat ones.
              let inHat = [];
              snapshot.forEach(child => {
                let content = child.val();
                if (content["inHat"] === true) {
                  inHat.push(child);
                }
              });

              let random = Math.floor(Math.random() * inHat.length);
              let chosen = inHat[random];
              let content = chosen.val();
              document.getElementById('revealed').textContent = content['phrase'];
              content["inHat"] = false;
              database.ref('phrases/' + chosen.key).set(content);
            });
          });

          // Put them all back
          let reset = document.getElementById('reset');
          reset.addEventListener('click', e => {
            database.ref('phrases').once('value').then(snapshot => {
              snapshot.forEach(child => {
                let content = child.val();
                content["inHat"] = true;
                database.ref('phrases/' + child.key).set(content);
              });
              document.getElementById('revealed').textContent = "";
            });
          });

          // Throw them all out and start over
          let trash = document.getElementById('trash');
          trash.addEventListener('click', e => {
            database.ref('phrases').once('value').then(snapshot => {
              snapshot.forEach(child => {
                child.ref.remove();
              });
              document.getElementById('revealed').textContent = "";
            });
          });
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
      });
    </script>
  </body>
</html>
